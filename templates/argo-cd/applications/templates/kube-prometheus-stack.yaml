---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argo-cd
  annotations:
    argocd.argoproj.io/sync-wave: "-40"
    strategy.spinnaker.io/replace: 'true'
spec:
  project: home
  source:
    repoURL: 'https://prometheus-community.github.io/helm-charts'
    targetRevision: 48.4.0
    chart: kube-prometheus-stack
    helm:
      skipCrds: true
      values: |
        prometheus:
          ingress:
            enabled: true
            hosts:
              - prometheus.bermanoc.net
            path: /
            pathType: Prefix
          prometheusSpec:
            additionalScrapeConfigs:
              - job_name: 'home-assistant'
                metrics_path: '/api/prometheus'
                scrape_interval: 60s
                scheme: http
                static_configs:
                  - targets: 
                    - '10.17.84.2:8123'
              - job_name: 'omada-exporter'
                metrics_path: '/metrics'
                scrape_interval: 60s
                scheme: http
                static_configs:
                  - targets: 
                    - 'omada-omada-exporter:9202'
        alertmanager:
          enabled: false
        grafana:
          ingress:
            enabled: true
            hosts:
              - grafana.bermanoc.net
            path: /
        sidecar:
          dashboards:
            enabled: true
      parameters: # Add this section
        - name: prometheus.prometheusSpec.additionalScrapeConfigs[0].bearer_token
          valueFrom:
            secretKeyRef:
              name: prometheus-secret
              key: prometheus_bearer_token
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: monitoring
  syncPolicy:
    syncOptions:
      - ServerSideApply=true
    automated:
      prune: true
      selfHeal: true
